---
# NOTE: this file is to be used for initial setup and requires root with password access,
# limit its operation to the node you want to set up.
#
# Should be run after a new server has been debootstraped or after cloning the
# template VM and adding a DNS entry into the Sophos-Firewall / DNS-Server.
#
# Variables (must be defined in `group_vars/all`):
#
#   dns_server: fw.in.example.com
#
# Example:
#
#   ansible-playbook --limit newserver.in.example.com -u root -k site-bootstrap.yml

- hosts: all
  vars:
    template_vm: false
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
  become: False
  tasks:
    - name: Detect template VM
      set_fact:
        template_vm: true
      when: ansible_hostname == "template-debian-stretch"
    - name: Check DNS entry for IP-Address
      local_action: command dig {{ inventory_hostname }} @{{ dns_server }} +short
      register: dig_result
      changed_when: False
      check_mode: no
    - name: Fail when no DNS entry is set
      fail: msg="DNS entry was not set in the Sophos Firewall / DNS-Server"
      when: dig_result.stdout == ""
      check_mode: no
    - name: Install sudo
      apt: name=sudo state=present
      when: not ansible_check_mode

    - name: Run role 'user'
      include_role:
        name: user
      vars:
        users: [ 'sysadmin' ]
        groupname: 'sysadmin'
        admin: true

    - name: Run role 'hostname'
      include_role:
        name: hostname
      when: not ansible_check_mode

    - name: Regenerate ssh host keys
      command: dpkg-reconfigure openssh-server
      when: template_vm == true
    - name: Delete machine-id files
      file:
        state: absent
        path: "{{ item }}"
      with_items:
        - "/etc/machine-id"
        - "/var/lib/dbus/machine-id"
      when: template_vm == true
    - name: Regenerate machine-id
      command: systemd-machine-id-setup
      when: template_vm == true
    - name: Update all packages to the latest version
      apt:
        upgrade: dist
        update_cache: yes
    - name: Disable ssh root login with password and restart service
      lineinfile: dest=/etc/ssh/sshd_config regexp='^PermitRootLogin' line='PermitRootLogin without-password'
    - service: name=ssh state=restarted
